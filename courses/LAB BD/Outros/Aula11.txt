--1
CREATE OR REPLACE TYPE P11DOADORT AS OBJECT(
  CPF_CNPJ NUMBER(11),
  Cidade VARCHAR2(100),
  Ramo VARCHAR2(100),
  MEMBER FUNCTION SET_RAMO(v_ramo VARCHAR2) RETURN VARCHAR2
);
/

--2
CREATE TABLE P11DOADOR OF P11DOADORT(
  CONSTRAINT P11DOADOR_PK PRIMARY KEY(CPF_CNPJ),
  CONSTRAINT P11RAMO_CH CHECK (Ramo IN ('Veiculos','Construcao')),
  CONSTRAINT P11CIDADE_CH CHECK (Cidade IN ('Lins','Jau','Itu'))
);
/

--3
CREATE OR REPLACE TYPE BODY P11DOADORT AS
  MEMBER FUNCTION SET_RAMO(v_ramo VARCHAR2) RETURN VARCHAR2 IS
    v VARCHAR2(100);
  BEGIN
    UPDATE P11DOADOR  SET RAMO = v_ramo WHERE CPF_CNPJ = SELF.CPF_CNPJ;
    SELECT RAMO INTO v FROM P11DOADOR WHERE CPF_CNPJ = SELF.CPF_CNPJ;
    RETURN v;
  END SET_RAMO;
END;
/

--4
CREATE OR REPLACE TYPE P11CANDIDATOT AS OBJECT(
  RGCandidato NUMBER(9),
  Nome VARCHAR2(100)
);
/

--5
CREATE TABLE P11CANDIDATO OF P11CANDIDATOT(
  CONSTRAINT P11CANDIDATO_PK PRIMARY KEY(RGCandidato)
);
/

--6
CREATE OR REPLACE TYPE P11DOACAOT AS OBJECT(
  CPF_CNPJ NUMBER(11),
  RGCandidato NUMBER(9),
  Ano NUMBER(4),

  Valor NUMBER(8,2),

  CPF_CNPJREF REF P11DOADORT,
  RGCandidatoREF REF P11CANDIDATOT
);
/

--7
CREATE TABLE P11DOACAO OF P11DOACAOT(
  CONSTRAINT P11DOACAO_PK PRIMARY KEY(CPF_CNPJ, RGCandidato, Ano),
  CONSTRAINT P11DOACAO_FK1 FOREIGN KEY(CPF_CNPJ) REFERENCES P11DOADOR(CPF_CNPJ),
  CONSTRAINT P11DOACAO_FK2 FOREIGN KEY(RGCandidato) REFERENCES P11CANDIDATO(RGCandidato), 
  CPF_CNPJREF WITH ROWID REFERENCES P11DOADOR,
  RGCandidatoREF WITH ROWID REFERENCES P11CANDIDATO
);
/

--8
INSERT INTO P11DOADOR VALUES(
 P11DOADORT(100, 'Jau', 'Veiculos')
);
INSERT INTO P11DOADOR VALUES(
 P11DOADORT(200, 'Lins', 'Construcao')
);

--9
INSERT INTO P11CANDIDATO VALUES(
 P11CANDIDATOT(5000,'Mario')
);
INSERT INTO P11CANDIDATO VALUES(
 P11CANDIDATOT(6000,'Luigi')
);

--10
INSERT INTO P11DOACAO VALUES(
 P11DOACAOT(
   100,
   6000,
   2010,
   50000,
   (SELECT REF(t) FROM P11DOADOR t WHERE CPF_CNPJ = 100),
   (SELECT REF(t) FROM P11CANDIDATO t WHERE RGCANDIDATO = 6000)
 )
);

INSERT INTO P11DOACAO VALUES(
 P11DOACAOT(
   200,
   5000,
   2009,
   100000,
   (SELECT REF(t) FROM P11DOADOR t WHERE CPF_CNPJ = 200),
   (SELECT REF(t) FROM P11CANDIDATO t WHERE RGCANDIDATO = 5000)
 )
);
  
--11 - Não há necessidade de junção
SELECT CPF_CNPJ, RGCandidato, ANO, VALOR, DEREF(CPF_CNPJREF), DEREF(RGCandidatoREF) FROM P11DOACAO;

--22
SET SERVEROUTPUT ON;
DECLARE 
  v_doador P11DOADORT;
BEGIN
  SELECT VALUE(v) INTO v_doador
         FROM P11DOADOR v 
         WHERE v.CPF_CNPJ = 100;

  dbms_output.put_line('Novo ramo: '|| v_doador.SET_RAMO('Construcao'));
END;




/*
DROP TABLE P11DOACAO;
DROP TABLE P11DOADOR;
DROP TABLE P11CANDIDATO;
DROP TYPE P11DOACAOT;
DROP TYPE P11DOADORT;
DROP TYPE P11CANDIDATOT;
*/